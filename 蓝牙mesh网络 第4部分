蓝牙网状网络中的设备管理
1 介绍
    蓝牙mesh网络就像一个专属俱乐部。如果您是俱乐部会员，您可以进入俱乐部并使用您的会员类型允许的设施和服务。如果你不是，不管你说什么，你都不能通过。
蓝牙mesh设备是特定蓝牙mesh网络的成员或者不是。如果它是成员，则它有权至少以基本方式与也是该网络成员的其他设备进行通信。如果它不是成员，那么设备发送
的任何内容都将被网络中的其他设备忽略。
    蓝牙mesh设备也可以被认为具有会员类型，例如可以访问特定的俱乐部设施（健身房，高尔夫球场等），但不能访问整个俱乐部。它只能与网络中的某些设
备完全交互。管理这个的概念是应用程序的概念。例如，蓝牙mesh灯开关可以在网络中打开或关闭蓝牙mesh灯，因为这些设备中的每一个都是照明应用的一部分。
灯开关无法打开加热系统，因为加热系统不是照明应用的一部分。
    要使设备成为蓝牙网状网络的成员，必须使用称为配置的安全过程将其添加到网络中。
2 安全
    安全性是蓝牙mesh网络的核心，我们将在本系列的后面部分详细介绍该主题。向蓝牙mesh网络添加设备或从蓝牙mesh网络中移除设备都是具有安全要求的过程。
    蓝牙mesh网络使用不同安全密钥类型的系统来保护整个网络以及保护和分离网络中的各个应用程序。在两种情况下，作为网络的成员并且有权参与特定应用程序
是具有正确安全密钥的设备的结果。网络中的所有节点都拥有一个称为网络密钥或NetKey的密钥。拥有该密钥使得设备成为该网络的成员，即其节点之一
3 命名法（Nomenclature）
    在早期的蓝牙mesh网络系列中，我们引入了正式的技术术语设备和节点。您可能还记得，作为mesh网络成员的设备称为节点，而不是mesh网络的设备称为设备。
我现在使用带有大写字母“D”的“Device”来表示一个尚未成为mesh网络一部分的设备并继续使用“设备”，就像我到目前为止，意思是更一般的电子产品，非正式的感觉。
4 The Provisioner
    Provisioner将一个简陋的设备转换为一个节点，一个蓝牙mesh网络的成熟成员。该过程使用应用程序完成，该应用程序通常由产品制造商提供用于智能手机或
 平板电脑，但可以采用其他形式，例如桌面或Web应用程序。
    运行配置应用程序的设备称为Provisioner。供应商必须物理安全，因为它具有非常特殊的作用。
5 The Provisioning Protocol
    在供应期间，供应商和要供应的设备使用称为供应协议的蓝牙网状协议进行通信。供应商可以通过PB-ADV或PB-GATT承载[i]使用供应协议，
确保供应商应用可以在较旧的智能手机上实施，只要求他们支持蓝牙低功耗（LE）和GATT。
6 将新设备添加到网络
    将设备添加到mesh网络主要涉及为其提供网络密钥，该网络的所有其他节点都具有该网络密钥。当然，该过程本身必须是安全的，以便恶意设备无法窃听在添加新设备
和窃取NetKey时发生的通信。
    当购买新设备并且需要将其添加到现有蓝牙mesh网络时，用户将使用配置器以及新设备制造商的指令将其添加到蓝牙mesh网络。
这会将新设备转换为蓝牙mesh网络的节点和成员。
    该过程涉及几个步骤，如下面的流程图所示。
    Step 1. Beaconing
          蓝牙mesh网络规范引入了新的<GAP AD>类型，包括<Mesh Beacon> AD Type [ii]。
      设备通过使用<Mesh Beacon>AD类型来指示其可用性，以将其自身通告为未设置的设备。用户可能需要按照制造商描述的程序以这种方式启动新设备广告，
      例如按下按钮组合或按住按钮一段时间。用户还将启动Provisioner中的“Add Device to Network”进程，这将使其接收来自Beaconing设备的广告数据包。
      请记住，Provisioner可能是智能手机或平板电脑应用程序，因此实际上，这涉及解锁智能手机，启动应用程序，可能登录应用程序（为了额外的安全性）
      并使用其用户界面启动查找Beaconing设备。通过这种方式，Provisioner可以了解新设备及其准备好完成配置过程的其余部分。
    Step 2. Invitation
          接下来，Provisioner向要配置的设备发送邀请消息。邀请采用Provisioning Invite PDU的形式，它是供应协议的一部分。信标设备在配置功能PDU中
      响应有关其自身的信息。供应能力PDU提供诸如它具有的元素数量以及它支持的供应相关算法之类的信息。它还指示设备具有的输入和输出功能的类型，以及在
      身份验证步骤中使用的信息。
    Step 3. Exchanging Public Keys
          所有蓝牙mesh设备（包括Provisioner）都支持FIPS P-256椭圆曲线算法，因此必须具有公钥。基于该算法的非对称密码术用于创建安全信道，在该信道
      上执行供应过程的剩余部分。为此，供应商和设备交换他们的公钥。注意，设备可以通过带外方法（例如QR码）提供其公钥。我们将在蓝牙网状网络系列的后续
      文章中关注mesh网安全性，包括配置安全性。
    Step 4. Authentication
          Provisioner利用其对新设备功能的了解并向其发送消息，该消息指示它输出单个或多个数字值以响应各种支持的用户操作之一，例如按下按钮。根据设备，
      输出的值将变化的形式。一个设备可能在LED面板上显示三位数字值，而另一个设备可能会多次闪烁红色LED，闪烁次数是输出验证值。 
      Provisioner的用户将观察设备输出的值并将其输入Provisioner用户界面。然后，设备和配置器交换加密哈希值，该加密哈希从包含由设备输出的随机值的数据
      导出，允许它们完成对等体的认证。
    Step 5. Distribution of the Provisioning Data
          在认证成功完成之后，会话密钥由两个设备中的每一个从其私钥和交换的对等公钥导出。然后，会话密钥用于保护完成供应过程所需的数据的后续分发，包括
      NetKey和设备的唯一地址，称为单播地址。配置完成后，配置的设备拥有网络的NetKey，一个称为IV索引的蓝牙网状网安全参数，它具有由配置者分配的单播
      地址[iii]。新设备现在正式成为Node并且是蓝牙网状网络的成员。
7 从网络中删除节点
    将需要移除蓝牙mesh网络的节点。设备可能已损坏并需要更换，或者可能需要将其移动到另一个公司位于不同城市的办公室中的另一个蓝牙mesh网络。
同样地，该设备可能已经出售，期望新的所有者将使用上述供应过程将设备添加到他们自己的蓝牙mesh网络。
    如果设备出现故障且无法修复，您可能只想将其丢入垃圾箱。如果你向某人出售设备，你也可能只想拿钱而忘记你的旧设备。然而，那是不明智的。
    节点包含通过配置过程提供的安全密钥。请记住，它拥有主NetKey，它确定设备是网络的成员，因此可以访问它。当您丢弃或出售设备时，将与蓝牙网状网络相关的
密钥留在设备内可能会使您的网络容易受到垃圾箱攻击。因此，已经定义了用于移除节点的安全过程，这消除了这种担忧，并且将在这里描述。
    从网络中删除节点涉及两个步骤。首先，Provisioner应用程序用于将要删除的节点添加到“黑名单”。其次，启动称为密钥刷新过程的过程。
8 黑名单
    使用Provisioner，用户必须将要删除的节点添加到其黑名单中。黑名单的目的只是作为启动密钥刷新过程时不得使用新安全密钥发出的那些节点的列表。
9 密钥刷新过程
    密钥刷新过程导致网络中的所有节点（黑名单成员除外）发布新网络密钥，应用程序密钥和所有相关的派生数据。换句话说，替换了构成网络和应用程序安全性基础
的整个安全密钥集。
    用户使用Provisioner启动密钥刷新，并且Provisioner使用配置消息创建新的密钥并将其发送到网状网络中的每个节点，但黑名单的成员除外。
    低功率节点将从他们的朋友那里收到新密钥。因此，它们可能需要相当长的时间才能收到它们，因此，整个网络都需要更换密钥。
    由于每个节点都不会在同一时间接收到新密钥，因此密钥刷新过程定义了一个称为“阶段2”的过渡期，在此期间使用了旧密钥和新密钥。
具体而言，传输使用新密钥，但支持接收消息的节点使用旧密钥和新密钥。
    当第2阶段已完成且每个未列出黑名单的节点已收到其新密钥时，Provisioner通知所有节点他们应撤销旧密钥。
    此时，从网络中删除并包含旧NetKey和一组旧AppKeys的节点不再是网络的成员，因此不构成威胁。
10 结论
    安全性是蓝牙mesh网络技术设计的核心。我们已经看到它如何在最基本的网络管理场景中表现出来，向蓝牙mesh网络添加新设备并将其删除。
