蓝牙mesh网络：Friend
    蓝牙低功耗（LE）是世界上功效最高的短距离无线通信技术之一。其低功耗受到开发人员和消费者的广泛赞誉。随着蓝牙网状网络的发布，
开发人员可能想知道蓝牙网格是否也在设计时考虑了低功耗。它是否继承了蓝牙LE低功耗的美感？
肯定的答案是肯定的！蓝牙网状网络包括用于优化功耗的各种措施，特别是称为“友谊”的特征。

1 概观
    Friend功能在蓝牙mesh网络中的应用可能非常多样化。一些产品，如灯，将连接到主电源（国家电网），蓝牙网模块的功耗与灯本身的功耗相比可以忽略不计。
但其他产品，如智能传感器或锁具，将受到功率限制，这意味着它们需要采用小型电池或能量收集技术。像这样的产品最有可能利用蓝牙mesh的Friend概念。
    如果您已阅读我们的蓝牙网状网络系列中的早期文章，您已经知道节点是已经配置并且是网状网络成员的设备。节点具有与产品类型相关的功能，
但也可以具有与网络本身的操作有关的功能，并且可以承担特殊角色。这取决于它们支持的网格特征。所有节点都可以在网络中发送和接收网状消息。
此外，节点还可以选择支持下面列出的一个或多个其他网络功能：
    中继特性：通过广告承载接收和重新传输mesh消息以启用更大网络的能力。
    代理特性：在GATT和广告承载之间接收和转发mesh消息的能力。
    低功耗特性：能够在mesh网络中以显着降低的接收器工作周期运行。最小化无线电接收器开启的时间导致较低的功耗，节点仅在必要时启用接收器。
低功耗节点（LPN）通过与Friend节点建立友谊来实现这一目标。
    朋友特性：通过存储发往LPN的消息来帮助LPN进行操作的能力，并且当LPN明确地请求来自Friend节点的消息时，仅将其转发给它。
    要了解友谊如何使LPN降低功耗，请考虑传感器。传感器是一种可能利用Friend并充当LPN的节点类型的一个很好的例子。他们通常花费最大比例的时间传输数据，
很少需要接收数据。也许传感器只有在超出一组配置限制时才传输温度读数，并且这可能每天只发生两次。这种不频繁的数据传输使这类设备的能耗保持在较低水平。
但是，如果需要修改这些温度限制以根据季节使用不同的值并通过向传感器发送配置消息来修改这些限制，该怎么办？对于传感器直接接收此类消息，需要打开无线
电并收听。大部分时间它都在倾听它什么也得不到，但是能量却消耗殆尽。因此，与朋友一起工作允许LPN安排其使用无线电以接收对该设备有意义的任何频率的消息，
并且频率低于其必须始终一直监听消息所需的频率。LPN向他们的Friend推荐新消息，Friend偶尔会存储这些消息。这就是节省电力的方式。

2 Friends and LPNs
    LPN必须与支持Friend功能的另一节点建立友谊关系，以减少其接收器占空比并节省能量。图1取自蓝牙网格配置文件规范。
除此之外，它还说明了LPN和朋友节点之间的关系。特别是它显示：
浅蓝色：LPNs 
深灰色：与特定LPN相关联的朋友节点
浅灰色：与LPN无关的朋友节点

朋友节点P与LPN I，J和K具有友好关系。朋友节点O与LPN L和M具有友好关系。因此，发往节点I，J或K的消息将由朋友P存储和转发。
节点L或M将由朋友O存储和转发。朋友节点的转发仅在LPN轮询朋友等待传递的消息时发生。

3 Friendship Parameters
    LPN需要找到朋友节点并与他们建立友谊关系。涉及的程序称为朋友建立。我们将很快检查这个过程，但在我们开始之前，
让我们介绍一些控制LPN行为的关键参数，因为这些是在Friend建立期间设置的。
    ReceiveDelay是LPN之间经过的时间，向Friend节点发送请求并开始侦听响应。这允许Friend节点时间准备其响应并将其发回。
    ReceiveWindow是LPN花费时间监听响应的时间。图2说明了涉及ReceiveDelay和ReceiveWindow的时序。
    PollTimeout建立LPN发送给其Friend节点的两个连续请求之间可能经过的最长时间。如果在PollTimeout定时器到期之前Friend节点
没有收到来自LPN的请求，则终止友谊。
4 Friend establishment
    如果两个人想要建立彼此的友谊，只需一看就足够了！为了建立蓝牙mesh网络中的友谊，还需要完成一些步骤。
LPN发布好友请求消息。此消息未被中继，因此只有直接无线电范围内的Friend节点才能对其进行处理。没有好友功能的节点会丢弃它。
朋友请求消息包括LPN所需的ReceiveDelay，ReceiveWindow和PollTimeout参数。
    附近的每个朋友节点可以支持朋友请求消息中指定的要求，准备并将朋友提议消息发送回LPN。此消息包括各种参数，包括支持的ReceiveWindow大小，
可用的消息队列大小，可用的订阅列表大小以及Friend节点测量的RSSI值。
    在接收到朋友提议消息时，LPN通过应用特定于实现的算法来选择合适的朋友节点。该算法可能会考虑各种要点。一些设备可以优先考虑ReceiveWindow大小
以尽可能地减少功率使用，而一些设备可能更关心RSSI值以确保它们能够与Friend节点保持良好质量的链接。使用的精确算法留给产品开发人员来确定。
    选择朋友节点后，LPN向此朋友节点发送朋友民意调查消息。
    在从LPN接收到朋友民意调查消息之后，朋友节点回复朋友更新消息，该消息结束朋友建立过程并提供安全参数。在这一点上，友谊已经建立。

5 Friendship messaging
    友谊建立后，Friend节点将所有LPN消息存储在Friend Queue中。这些被称为存储消息。下面的图4说明了Friend节点和相关LPN之间的消息交换。
        当Friend节点收到发往Friend节点的LPN的消息时，Friend节点缓冲此消息，将其存储在名为Friend Queue的区域中。
    在图4中，我们可以看到消息1和2代表LPN存储在Friend节点中。
        LPN定期启用其收发器并向Friend节点发送Friend Poll，询问为其存储的任何缓冲消息。
        Friend节点首先将一条存储的消息发送回LPN作为对朋友民意调查的响应。
        LPN在从Friend节点接收到每条消息之后继续发送Friend Poll消息，直到它收到一条MD（MD = More Data）字段设置为0的Friend Update消息。
    这意味着没有更多消息为LPN缓冲。此时，LPN停止轮询Friend节点。
6 Security
    蓝牙mesh无处不在。友谊没有什么不同，它使用两个特殊的安全凭证：
       主安全材料：源自NetKey，也可以由同一网络中的其他节点使用。使用主安全材料加密的消息可以由同一网络中的任何节点解密。
       朋友安全材料：源自NetKey以及由LPN和Friend节点生成的一些其他计数器编号。使用朋友安全材料加密的消息只能由拥有它的朋友和LPN解密。
LPN和Friend节点如何使用这两种安全材料？以下是摘要：
    使用朋友安全材料加密的相应友情消息是：
        朋友投票、朋友更新、朋友订阅列表添加/删除/确认、朋友节点传递给LPN的存储消息
    使用主安全材料加密的相应友情消息是：
        朋友清除、朋友清除确认
    从LPN发送到Friend节点的消息使用主或朋友安全材料加密，具体取决于应用程序设置。
7 Friendship Termination（友谊终止）
    友谊可以在某些条件下终止：
    如果在PollTimeout计时器到期之前，朋友节点没有收到朋友投票，朋友订阅列表添加或朋友订阅列表删除消息，则友谊终止。
    LPN可以通过向其Friend节点发送Friend Clear消息来启动友谊终止过程，从而导致友谊被Friend节点终止。

8 平台选择技巧
    在选择实施Friend和LPN的平台时，开发人员应考虑以下准则：
      RAM容量:可用的RAM量直接影响Friend节点可以支持的LPN数量以及可以为关联的LPN缓冲的消息数量。
      LPNs:所选MCU和模块的一般功耗性能是LPN的关键。此外，从睡眠模式到运行模式的唤醒/预热时间会影响LPN的响应性和延迟。

